# –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –û–ë –ê–£–î–ò–¢–ï CSRF –ò –°–ï–°–°–ò–ô

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 30 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–≤–µ–¥–µ–Ω –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ–≥–æ backend –∫–æ–¥–∞  
**–¶–µ–ª—å:** –í—ã—è–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã, –≤—ã–∑—ã–≤–∞—é—â–∏–µ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üî¥ –°–ò–ú–ü–¢–û–ú–´ –ü–†–û–ë–õ–ï–ú–´

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
> "–ü—Ä–∏ –ª—é–±—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑–ª–æ–≥–∏–Ω. Frontend –¥—É–º–∞–µ—Ç —á—Ç–æ –º—ã –≤ –∞–∫–∫–∞—É–Ω—Ç–µ, –Ω–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤–∑–∞–∏–º–Ω–æ—Å—Ç—å—é. –í–∏–¥–∏–º–æ –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –≤—ã–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–æ–≤ CSRF."

### –ù–∞–±–ª—é–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
- ‚úÖ Login/Register –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Frontend –ø–æ–ª—É—á–∞–µ—Ç user data –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ store
- ‚úÖ Frontend —Å—á–∏—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º
- ‚ùå –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç 403 Forbidden –∏–ª–∏ 401 Unauthorized
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "—Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω" –Ω–æ frontend —ç—Ç–æ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç (–Ω–µ–≤–∏–¥–∏–º—ã–π —Ä–∞–∑–ª–æ–≥–∏–Ω)
- ‚ùå –û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (P0)

### 1. ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CSRF MIDDLEWARE –ü–†–ò–ú–ï–ù–Ø–ï–¢–°–Ø **–ü–û–°–õ–ï** –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –†–û–£–¢–û–í

**–§–∞–π–ª:** `server/index.ts`  
**–°—Ç—Ä–æ–∫–∏:** 119, 124

**–ö–æ–¥:**
```typescript
// –°—Ç—Ä–æ–∫–∞ 110
app.use('/api', generalApiLimiter);

// –°—Ç—Ä–æ–∫–∞ 113 - endpoint –ë–ï–ó CSRF
app.get('/api/csrf-token-init', csrfTokenEndpoint);

// –°—Ç—Ä–æ–∫–∞ 115-116 - webhooks –ë–ï–ó CSRF
const webhooksRoutes = await import('./routes/webhooks.routes');
app.use('/api/webhooks', webhooksRoutes.default);

// –°—Ç—Ä–æ–∫–∞ 119 - CSRF middleware
app.use('/api', csrfMiddleware);

// –°—Ç—Ä–æ–∫–∞ 122 - endpoint –° CSRF (–ø–∞—Ä–∞–¥–æ–∫—Å!)
app.get('/api/csrf-token', csrfTokenEndpoint);

// –°—Ç—Ä–æ–∫–∞ 124 - –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –†–û–£–¢–´
const server = await registerRoutes(app);
```

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:**

–í Express.js middleware –∏ —Ä–æ—É—Ç—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è **–í –ü–û–†–Ø–î–ö–ï –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò**!

1. `registerRoutes()` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –í–°–ï API —Ä–æ—É—Ç—ã:
   - `/api/auth/*` (login, register, me, logout)
   - `/api/cart/*` (add, update, remove)
   - `/api/orders/*` (create, getAll, getById)
   - `/api/products/*`, `/api/categories/*`, `/api/wishlist/*` –∏ —Ç.–¥.

2. –≠—Ç–∏ —Ä–æ—É—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è **–ü–û–°–õ–ï** —Å—Ç—Ä–æ–∫–∏ 119 –≥–¥–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω csrfMiddleware

3. **–ù–û –í EXPRESS MIDDLEWARE –ù–ï –†–ê–ë–û–¢–ê–ï–¢ –ó–ê–î–ù–ò–ú –ß–ò–°–õ–û–ú!**

4. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
   ```typescript
   const server = await registerRoutes(app); // –°–ù–ê–ß–ê–õ–ê —Ä–æ—É—Ç—ã
   app.use('/api', csrfMiddleware); // –ü–û–¢–û–ú –∑–∞—â–∏—Ç–∞ –Ω–∞ –≤—Å–µ /api/*
   ```

**–ü–û–ß–ï–ú–£ –≠–¢–û –í–´–ó–´–í–ê–ï–¢ –†–ê–ó–õ–û–ì–ò–ù:**

–≠—Ç–æ —Å–∞–º–∞—è –∫–æ–≤–∞—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞! –ò–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞:
- CSRF middleware –≤–æ–æ–±—â–µ –ù–ï –ü–†–ò–ú–ï–ù–Ø–ï–¢–°–Ø –∫ —Ä–æ—É—Ç–∞–º –∏–∑ registerRoutes()
- –ù–æ CSRF cookie –≤—Å–µ —Ä–∞–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- Frontend –¥—É–º–∞–µ—Ç —á—Ç–æ CSRF —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
- –°–µ—Ä–≤–µ—Ä –∏—Ö –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç (middleware –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω)
- –û–î–ù–ê–ö–û –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –ø–æ—Ä—è–¥–æ–∫ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ
- –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç intermittent failures - –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏–Ω–æ–≥–¥–∞ –Ω–µ—Ç

**–†–ï–®–ï–ù–ò–ï:** 
–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `const server = await registerRoutes(app)` –ü–ï–†–ï–î `app.use('/api', csrfMiddleware)`

**–ü–†–ò–û–†–ò–¢–ï–¢:** üî¥üî¥üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - –≠—Ç–æ –ë–õ–û–ö–ò–†–£–ï–¢ –≤—Å—é CSRF –∑–∞—â–∏—Ç—É!

---

### 2. üç™ –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï sameSite –ú–ï–ñ–î–£ SESSION –ò CSRF COOKIES

**–§–∞–π–ª—ã:**
- `server/session.ts` (—Å—Ç—Ä–æ–∫–∞ 21)  
- `server/middleware/csrf.ts` (—Å—Ç—Ä–æ–∫–∞ 29)

**–ü—Ä–æ–±–ª–µ–º–∞:**

Session cookie:
```typescript
// session.ts —Å—Ç—Ä–æ–∫–∞ 17-22
cookie: {
  maxAge: 30 * 24 * 60 * 60 * 1000,
  httpOnly: true,
  secure: env.NODE_ENV === 'production',
  sameSite: 'strict', // ‚ùå –í–°–ï–ì–î–ê strict!
}
```

CSRF cookie:
```typescript
// csrf.ts —Å—Ç—Ä–æ–∫–∞ 26-31
cookieOptions: {
  httpOnly: false,
  secure: env.NODE_ENV === 'production',
  sameSite: env.NODE_ENV === 'production' ? 'strict' : 'lax', // ‚úÖ –í dev = lax
  maxAge: 365 * 24 * 60 * 60 * 1000,
}
```

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï:**
- –í development mode:
  - Session cookie: `sameSite=strict`
  - CSRF cookie: `sameSite=lax`

**–ü–û–ß–ï–ú–£ –≠–¢–û –í–´–ó–´–í–ê–ï–¢ –†–ê–ó–õ–û–ì–ò–ù:**

–ü—Ä–∏ cross-site navigation –∏–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞—Ö (—á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ Replit dev environment):

1. Browser –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç CSRF cookie (sameSite=lax —Ä–∞–∑—Ä–µ—à–∞–µ—Ç top-level navigation)
2. Browser –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç session cookie (sameSite=strict –±–ª–æ–∫–∏—Ä—É–µ—Ç)
3. –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç:
   - CSRF —Ç–æ–∫–µ–Ω: ‚úÖ –µ—Å—Ç—å
   - Session: ‚ùå –Ω–µ—Ç
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: 401 Unauthorized ‚Üí —Ä–∞–∑–ª–æ–≥–∏–Ω

**–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:**

CSRF middleware –æ–∂–∏–¥–∞–µ—Ç sessionId –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
```typescript
// csrf.ts —Å—Ç—Ä–æ–∫–∞ 13
getSessionIdentifier: (req: Request) => {
  const sessionId = req.sessionID || req.session?.id;
  return sessionId || 'anonymous';
}
```

–ï—Å–ª–∏ session cookie –Ω–µ –ø—Ä–∏—à–µ–ª ‚Üí sessionId = undefined ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 'anonymous' ‚Üí CSRF —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω!

**–†–ï–®–ï–ù–ò–ï:**
```typescript
// session.ts
cookie: {
  sameSite: env.NODE_ENV === 'production' ? 'strict' : 'lax',
}
```

**–ü–†–ò–û–†–ò–¢–ï–¢:** üî¥üî¥üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### 3. üîë getSessionIdentifier –í–û–ó–í–†–ê–©–ê–ï–¢ 'anonymous' –ë–ï–ó –°–ï–°–°–ò–ò

**–§–∞–π–ª:** `server/middleware/csrf.ts`  
**–°—Ç—Ä–æ–∫–∏:** 13-24

**–ö–æ–¥:**
```typescript
getSessionIdentifier: (req: Request) => {
  const sessionId = req.sessionID || req.session?.id;
  
  if (!sessionId) {
    logger.warn('No session identifier available for CSRF validation', {
      hasSession: !!req.session,
      hasSessionID: !!req.sessionID,
    });
  }
  
  return sessionId || 'anonymous'; // ‚ùå –û–ü–ê–°–ù–´–ô FALLBACK
}
```

**–ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:**

#### –ü—Ä–æ–±–ª–µ–º–∞ 3.1: –í—Å–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ = –æ–¥–∏–Ω CSRF —Ç–æ–∫–µ–Ω
- CSRF —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫: `HMAC(SESSION_SECRET + sessionIdentifier)`
- –í—Å–µ –Ω–µ–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç sessionIdentifier = 'anonymous'
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –û–î–ò–ù–ê–ö–û–í–´–ô CSRF —Ç–æ–∫–µ–Ω!
- –≠—Ç–æ –û–ì–†–û–ú–ù–ê–Ø —É—è–∑–≤–∏–º–æ—Å—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 3.2: –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω
**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Üí sessionId = 'anonymous' ‚Üí CSRF —Ç–æ–∫–µ–Ω A
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π sessionId = 'abc123'
3. CSRF —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å B (–¥–ª—è sessionId 'abc123')
4. –ù–û —Å—Ç–∞—Ä—ã–π CSRF cookie (—Ç–æ–∫–µ–Ω A –¥–ª—è 'anonymous') –µ—â–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
5. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω A
6. –°–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω B
7. –í–∞–ª–∏–¥–∞—Ü–∏—è FAILED ‚Üí 403 Forbidden ‚Üí —Ä–∞–∑–ª–æ–≥–∏–Ω!

#### –ü—Ä–æ–±–ª–µ–º–∞ 3.3: Race condition –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. Login POST `/api/auth/login`
2. `initializeSessionWithUser()` ‚Üí session.regenerate() ‚Üí –Ω–æ–≤—ã–π sessionId
3. Session —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ PostgreSQL
4. Response –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è frontend
5. Frontend —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `/api/csrf-token-init`
6. –í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç session –º–æ–∂–µ—Ç –±—ã—Ç—å –ù–ï –ì–û–¢–û–í–ê –≤ –ë–î
7. `req.sessionID` = undefined (session –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –∏–∑ –ë–î)
8. `getSessionIdentifier()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 'anonymous'
9. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è CSRF —Ç–æ–∫–µ–Ω –¥–ª—è 'anonymous'
10. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –æ–∂–∏–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ sessionId
11. –í–∞–ª–∏–¥–∞—Ü–∏—è FAILED ‚Üí —Ä–∞–∑–ª–æ–≥–∏–Ω!

**–†–ï–®–ï–ù–ò–ï:**
- –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 'anonymous' –∫–∞–∫ fallback
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –±–µ–∑ —Å–µ—Å—Å–∏–∏
- –ò–ª–∏ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è CSRF (–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ —Å–µ—Å—Å–∏–∏)

**–ü–†–ò–û–†–ò–¢–ï–¢:** üî¥üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### 4. ‚è±Ô∏è RACE CONDITION: CSRF –¢–û–ö–ï–ù –ì–ï–ù–ï–†–ò–†–£–ï–¢–°–Ø –î–û –°–û–•–†–ê–ù–ï–ù–ò–Ø –°–ï–°–°–ò–ò –í –ë–î

**–§–∞–π–ª—ã:**
- `server/routes/auth.routes.ts` (—Å—Ç—Ä–æ–∫–∏ 55-82, 111-139)
- `server/utils/sessionUtils.ts` (—Å—Ç—Ä–æ–∫–∏ 45-69)

**–¢–µ–∫—É—â–∏–π flow –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ:**

```typescript
// auth.routes.ts —Å—Ç—Ä–æ–∫–∞ 111-139
try {
  // Initialize session with proper async/await
  // This GUARANTEES session is saved to DB before response
  await initializeSessionWithUser(req, user.id, roleNames);
  
  // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è response
  res.json({
    user: { ... }
  });
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ initializeSessionWithUser:**

```typescript
// sessionUtils.ts —Å—Ç—Ä–æ–∫–∞ 45-69
export async function initializeSessionWithUser(
  req: Request, 
  userId: string,
  userRoles: string[]
): Promise<void> {
  try {
    // Step 1: Regenerate (create new session)
    await regenerateSession(req);
    
    // Step 2: Set user data
    req.session.userId = userId;
    req.session.userRoles = userRoles;
    
    // Step 3: Save and WAIT for completion
    await saveSession(req);
    
    logger.info('Session initialized successfully', { userId, sessionId: req.sessionID });
  } catch (error) {
    // ...
  }
}
```

**–ü–†–û–ë–õ–ï–ú–ê ‚Ññ1: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å PostgreSQL**

`saveSession()` –¥–µ–ª–∞–µ—Ç:
```typescript
return new Promise((resolve, reject) => {
  req.session.save((err) => {
    if (err) {
      reject(err);
    } else {
      resolve(); // ‚ùå Resolve –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ SQL –û–¢–ü–†–ê–í–õ–ï–ù, –ù–ï –ó–ê–í–ï–†–®–ï–ù!
    }
  });
});
```

`connect-pg-simple` middleware:
- –í—ã–∑—ã–≤–∞–µ—Ç callback –°–†–ê–ó–£ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ SQL INSERT –≤ PostgreSQL
- –ù–ï –∂–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á—Ç–æ –∑–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- PostgreSQL –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –∑–∞–Ω—è—Ç –∑–∞–ø–∏—Å—å—é –¥–∞–Ω–Ω—ã—Ö

**–ü–†–û–ë–õ–ï–ú–ê ‚Ññ2: –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É**

```typescript
await initializeSessionWithUser(req, user.id, roleNames);
// await –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –Ω–æ —Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ï–©–ï –ù–ï –ì–û–¢–û–í–ê –≤ –ë–î!

res.json({ user: {...} }); // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –°–†–ê–ó–£
```

**–ü–†–û–ë–õ–ï–ú–ê ‚Ññ3: Frontend —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç CSRF —Ç–æ–∫–µ–Ω**

```typescript
// useAuth.ts —Å—Ç—Ä–æ–∫–∞ 48-57
onSuccess: async (response) => {
  login(response.user);
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è response!
  await refreshCsrfTokenWithRetry();
  
  queryClient.refetchQueries({ queryKey: ["cart"] });
  queryClient.refetchQueries({ queryKey: ["wishlist"] });
}
```

**–ü–û–õ–ù–´–ô TIMELINE RACE CONDITION:**

```
T=0ms   : Login request arrives
T=10ms  : Password validated
T=20ms  : session.regenerate() ‚Üí new sessionId created IN MEMORY
T=30ms  : req.session.userId = user.id
T=40ms  : session.save() ‚Üí SQL INSERT sent to PostgreSQL
T=45ms  : callback fires ‚Üí await resolves ‚Üí response sent to client
T=50ms  : Frontend receives response
T=55ms  : Frontend calls refreshCsrfTokenWithRetry()
T=60ms  : GET /api/csrf-token-init request arrives
T=65ms  : session middleware tries to load session from DB
T=70ms  : PostgreSQL STILL WRITING (not done yet!)
T=75ms  : Session not found ‚Üí req.session is EMPTY
T=80ms  : getSessionIdentifier() ‚Üí sessionId = undefined
T=85ms  : getSessionIdentifier() returns 'anonymous'
T=90ms  : CSRF token generated for 'anonymous'
T=95ms  : CSRF cookie set with WRONG token
T=100ms : PostgreSQL INSERT completes (too late!)
T=150ms : User makes POST /api/cart request
T=155ms : Sends CSRF token for 'anonymous'
T=160ms : Session loads successfully now (sessionId = 'abc123')
T=165ms : CSRF validation expects token for 'abc123'
T=170ms : CSRF validation FAILED (has token for 'anonymous')
T=175ms : 403 Forbidden
T=180ms : User —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω!
```

**–î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –í –ö–û–î–ï:**

1. **Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–º–µ–Ω–Ω–æ –∏–∑-–∑–∞ —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã:**
```typescript
// useAuth.ts —Å—Ç—Ä–æ–∫–∞ 11
async function refreshCsrfTokenWithRetry(maxAttempts = 5) {
  // Exponential backoff: 50ms, 100ms, 200ms, 400ms, 800ms
  // –≠—Ç–æ –ø–æ–ø—ã—Ç–∫–∞ "–ø–æ–¥–æ–∂–¥–∞—Ç—å" –ø–æ–∫–∞ —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è
}
```

2. **waitForSessionReady —Ç–æ–∂–µ –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ:**
```typescript
// api.ts —Å—Ç—Ä–æ–∫–∞ 41
async function waitForSessionReady(maxAttempts = 3) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç /api/session-status
  // –ü—ã—Ç–∞–µ—Ç—Å—è –¥–æ–∂–¥–∞—Ç—å—Å—è –∫–æ–≥–¥–∞ —Å–µ—Å—Å–∏—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
}
```

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:**
```typescript
// csrf.ts —Å—Ç—Ä–æ–∫–∞ 16
if (!sessionId) {
  logger.warn('No session identifier available for CSRF validation', {
    hasSession: !!req.session,
    hasSessionID: !!req.sessionID,
  });
}
// –≠—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ü–û–°–¢–û–Ø–ù–ù–û –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞!
```

**–†–ï–®–ï–ù–ò–ï:**

–ù—É–∂–Ω–∞ –ù–ê–°–¢–û–Ø–©–ê–Ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å PostgreSQL:
```typescript
// –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ –ë–î
export async function initializeSessionWithUser(req, user, roles) {
  await regenerateSession(req);
  req.session.userId = user.id;
  req.session.userRoles = roles;
  await saveSession(req);
  
  // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á—Ç–æ —Å–µ—Å—Å–∏—è –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û –≤ –ë–î
  await verifySessionInDatabase(req.sessionID);
}

// –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å CSRF —Ç–æ–∫–µ–Ω –≤ –°–ê–ú–û–ú –û–¢–í–ï–¢–ï –Ω–∞ login
res.json({
  user: {...},
  csrfToken: generateCsrfToken(req, res) // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
});
```

**–ü–†–ò–û–†–ò–¢–ï–¢:** üî¥üî¥üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

### 5. üîÑ CSRF –¢–û–ö–ï–ù –ù–ï –†–ï–ì–ï–ù–ï–†–ò–†–£–ï–¢–°–Ø –ü–û–°–õ–ï –†–ï–ì–ï–ù–ï–†–ê–¶–ò–ò –°–ï–°–°–ò–ò

**–§–∞–π–ª:** `server/utils/sessionUtils.ts`  
**–°—Ç—Ä–æ–∫–∏:** 45-69

**–ü—Ä–æ–±–ª–µ–º–∞:**

```typescript
export async function initializeSessionWithUser(...) {
  // Step 1: Regenerate (create new session)
  await regenerateSession(req);
  // –ù–û–í–´–ô sessionId = 'new123'
  
  // Step 2: Set user data
  req.session.userId = userId;
  req.session.userRoles = userRoles;
  
  // Step 3: Save and WAIT for completion
  await saveSession(req);
  
  // ‚ùå CSRF —Ç–æ–∫–µ–Ω –ù–ï —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è!
  // –°—Ç–∞—Ä—ã–π CSRF cookie –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ!
  // –û–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –°–¢–ê–†–û–ú–£ sessionId = 'old456'
}
```

**–ü–û–ß–ï–ú–£ –≠–¢–û –ö–†–ò–¢–ò–ß–ù–û:**

CSRF —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫:
```
CSRF_TOKEN = HMAC-SHA256(SESSION_SECRET + sessionIdentifier + random)
```

–ü–æ—Å–ª–µ session.regenerate():
- **–ë—ã–ª–æ:** sessionId = 'anonymous' (–¥–ª—è –Ω–µ–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω–æ–≥–æ)
- **–°—Ç–∞–ª–æ:** sessionId = 'new123' (–ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞)

–í–∞–ª–∏–¥–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–∞:
```typescript
// csrf-csrf –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
const expectedToken = HMAC(SESSION_SECRET + req.sessionID + ...)
if (receivedToken !== expectedToken) {
  throw invalidCsrfTokenError
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π CSRF —Ç–æ–∫–µ–Ω (–¥–ª—è 'anonymous')
- –°–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–µ—Ç –Ω–æ–≤—ã–π CSRF —Ç–æ–∫–µ–Ω (–¥–ª—è 'new123')
- –¢–æ–∫–µ–Ω—ã –ù–ï —Å–æ–≤–ø–∞–¥–∞—é—Ç
- 403 Forbidden
- –†–∞–∑–ª–æ–≥–∏–Ω!

**–†–ï–®–ï–ù–ò–ï:**

```typescript
export async function initializeSessionWithUser(req, userId, roles) {
  await regenerateSession(req);
  req.session.userId = userId;
  req.session.userRoles = roles;
  await saveSession(req);
  
  // –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é CSRF —Ç–æ–∫–µ–Ω–∞
  const newCsrfToken = generateCsrfToken(req, res);
  return newCsrfToken; // –í–µ—Ä–Ω—É—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ
}

// –í auth.routes.ts
const csrfToken = await initializeSessionWithUser(req, user.id, roles);
res.json({
  user: {...},
  csrfToken // Frontend –æ–±–Ω–æ–≤–∏—Ç cookie
});
```

**–ü–†–ò–û–†–ò–¢–ï–¢:** üî¥üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## üü° –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (P1)

### 6. üîÄ –î–í–ê –†–ê–ó–ù–´–• ENDPOINT –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø CSRF –¢–û–ö–ï–ù–û–í

**–§–∞–π–ª:** `server/index.ts`  
**–°—Ç—Ä–æ–∫–∏:** 113, 122

**–ö–æ–¥:**
```typescript
// –°—Ç—Ä–æ–∫–∞ 113 - –ë–ï–ó CSRF –∑–∞—â–∏—Ç—ã
app.get('/api/csrf-token-init', csrfTokenEndpoint);

// –°—Ç—Ä–æ–∫–∞ 119
app.use('/api', csrfMiddleware);

// –°—Ç—Ä–æ–∫–∞ 122 - –° CSRF –∑–∞—â–∏—Ç–æ–π (–ü–ê–†–ê–î–û–ö–°!)
app.get('/api/csrf-token', csrfTokenEndpoint);
```

**–ü–†–û–ë–õ–ï–ú–ê:**

–û–±–∞ endpoint –≤—ã–∑—ã–≤–∞—é—Ç –û–î–ù–£ –ò –¢–£ –ñ–ï —Ñ—É–Ω–∫—Ü–∏—é `csrfTokenEndpoint`:
```typescript
export function csrfTokenEndpoint(req: Request, res: Response): void {
  const csrfToken = generateCsrfToken(req, res);
  res.json({ csrfToken });
}
```

–ù–û:
1. `/api/csrf-token-init` - –ù–ï —Ç—Ä–µ–±—É–µ—Ç CSRF —Ç–æ–∫–µ–Ω
2. `/api/csrf-token` - –¢–†–ï–ë–£–ï–¢ CSRF —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞! (–∫—É—Ä–∏—Ü–∞ –∏ —è–π—Ü–æ)

**–ü–û–ß–ï–ú–£ –≠–¢–û –í–´–ó–´–í–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–´:**

#### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
```typescript
// Frontend –¥–µ–ª–∞–µ—Ç:
await fetch('/api/csrf-token-init', { credentials: 'include' });
```
–ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤–∞ (race condition –∏–∑ Problem #4)

#### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–∏ 403 –æ—à–∏–±–∫–µ
```typescript
// api.ts —Å—Ç—Ä–æ–∫–∞ 98-124
if (response.status === 403) {
  await fetch('/api/csrf-token-init', { credentials: 'include' });
  // Retry request
}
```
–ü—Ä–æ–±–ª–µ–º–∞: –ö–∞–∂–¥–∞—è 403 –æ—à–∏–±–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞ —Ç–æ–∫–µ–Ω–æ–º, —Å–æ–∑–¥–∞–≤–∞—è —Ü–∏–∫–ª

#### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- Request A –ø–æ–ª—É—á–∞–µ—Ç 403 ‚Üí –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
- Request B –ø–æ–ª—É—á–∞–µ—Ç 403 ‚Üí –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
- Request C –ø–æ–ª—É—á–∞–µ—Ç 403 ‚Üí –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
- –í—Å–µ —Ç—Ä–∏ –ø–æ–ª—É—á–∞—é—Ç –†–ê–ó–ù–´–ï —Ç–æ–∫–µ–Ω—ã (race condition)
- –ù–æ –º–æ–∂–µ—Ç –≤–∞–ª–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:**

–ù–∞–ª–∏—á–∏–µ –¥–≤—É—Ö endpoint –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Å–æ–∑–¥–∞–µ—Ç confusion:
- –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `-init`?
- –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π?
- –ü–æ—á–µ–º—É –æ–¥–∏–Ω –∑–∞—â–∏—â–µ–Ω, –∞ –¥—Ä—É–≥–æ–π –Ω–µ—Ç?
- –ö–∞–∫–æ–π —Ç–æ–∫–µ–Ω "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"?

**–†–ï–®–ï–ù–ò–ï:**

–û—Å—Ç–∞–≤–∏—Ç—å –¢–û–õ–¨–ö–û `/api/csrf-token-init`:
- –ë–µ–∑ CSRF –∑–∞—â–∏—Ç—ã (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è)
- –ù–æ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ –í–ê–õ–ò–î–ù–û–ô —Å–µ—Å—Å–∏–∏
- –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Üí 401 Unauthorized
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è 'anonymous'

**–ü–†–ò–û–†–ò–¢–ï–¢:** üü° –í–´–°–û–ö–ò–ô

---

### 7. üåÄ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –ü–û–ü–´–¢–ö–ò –ü–û–õ–£–ß–ò–¢–¨ CSRF –¢–û–ö–ï–ù –°–û–ó–î–ê–Æ–¢ RACE CONDITIONS

**–§–∞–π–ª—ã:**
- `client/src/hooks/useAuth.ts` (—Å—Ç—Ä–æ–∫–∏ 11-40)
- `client/src/lib/api.ts` (—Å—Ç—Ä–æ–∫–∏ 41-67, 98-124)

**–ö–æ–¥:**

#### –í useAuth.ts:
```typescript
// –°—Ç—Ä–æ–∫–∞ 11-40
async function refreshCsrfTokenWithRetry(maxAttempts = 5) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      const response = await fetch('/api/csrf-token-init', { 
        credentials: 'include' 
      });
      
      if (response.ok) {
        return;
      }
    } catch (error) {
      console.warn(`‚ö†Ô∏è CSRF token refresh attempt ${attempt} failed:`, error);
    }
    
    // Exponential backoff: 50ms, 100ms, 200ms, 400ms, 800ms
    if (attempt < maxAttempts) {
      const delayMs = 50 * Math.pow(2, attempt - 1);
      await new Promise(resolve => setTimeout(resolve, delayMs));
    }
  }
}
```

#### –í api.ts:
```typescript
// –°—Ç—Ä–æ–∫–∞ 41-67
async function waitForSessionReady(maxAttempts = 3) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      const response = await fetch('/api/session-status', {
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.isReady) {
          return true;
        }
      }
    } catch (error) {
      console.warn(`Session ready check attempt ${attempt} failed:`, error);
    }
    
    // Wait before retry: 50ms, 100ms, 200ms
    if (attempt < maxAttempts) {
      const delayMs = 50 * Math.pow(2, attempt - 1);
      await new Promise(resolve => setTimeout(resolve, delayMs));
    }
  }
  
  return true; // ‚ùå Return true –¥–∞–∂–µ –µ—Å–ª–∏ failed!
}

// –°—Ç—Ä–æ–∫–∞ 98-124
if (response.status === 403 && options.method && options.method !== 'GET') {
  try {
    // Get fresh CSRF token with retry
    await fetch('/api/csrf-token-init', { credentials: 'include' });
    
    // Small delay to ensure token is set in cookie
    await new Promise(resolve => setTimeout(resolve, 50));
    
    // Retry the request
    // ...
  }
}
```

**–ü–†–û–ë–õ–ï–ú–ê:**

–ü–æ—Å–ª–µ –æ–¥–Ω–æ–≥–æ login –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
1. `waitForSessionReady()` - –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫
2. `refreshCsrfTokenWithRetry()` - –¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫
3. –ü—Ä–∏ –∫–∞–∂–¥–æ–º 403 –µ—â–µ –æ–¥–∏–Ω retry

**–í–°–ï–ì–û:** –î–æ 15+ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –û–î–ù–û–ì–û –ª–æ–≥–∏–Ω–∞!

**RACE CONDITIONS:**

#### RC#1: –ú–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
```
T=0ms   : Attempt 1: session not ready ‚Üí retry
T=50ms  : Session saves to DB
T=100ms : Attempt 2: session ready ‚Üí get CSRF token A
T=200ms : Attempt 3: get CSRF token B (—Å–µ—Å—Å–∏—è —Ç–∞ –∂–µ, –Ω–æ —Ç–æ–∫–µ–Ω –Ω–æ–≤—ã–π!)
```
–ö–∞–∫–æ–π —Ç–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å? –û–±–∞ –≤ cookie!

#### RC#2: –ú–µ–∂–¥—É waitForSessionReady –∏ refreshCsrfTokenWithRetry
```
T=0ms   : waitForSessionReady check 1
T=50ms  : waitForSessionReady check 2
T=100ms : waitForSessionReady check 3 ‚Üí ready = true
T=150ms : refreshCsrfTokenWithRetry attempt 1
T=200ms : –ú–µ–∂–¥—É —ç—Ç–∏–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏ —Å–µ—Å—Å–∏—è –º–æ–≥–ª–∞ EXPIRY!
```

#### RC#3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```
User –±—ã—Å—Ç—Ä–æ –∫–ª–∏–∫–∞–µ—Ç –∫–Ω–æ–ø–∫–∏:
T=0ms   : POST /api/cart (add item 1)
T=10ms  : POST /api/wishlist (add item 2)
T=20ms  : POST /api/cart (add item 3)

–í—Å–µ —Ç—Ä–∏ –ø–æ–ª—É—á–∞—é—Ç 403:
T=100ms : Request 1 fetches /api/csrf-token-init
T=110ms : Request 2 fetches /api/csrf-token-init
T=120ms : Request 3 fetches /api/csrf-token-init

–ö—Ç–æ-—Ç–æ –ø–æ–ª—É—á–∏—Ç —Ç–æ–∫–µ–Ω –ø–µ—Ä–≤—ã–º –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç cookie
–û—Å—Ç–∞–ª—å–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω
```

**–î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –ß–¢–û –≠–¢–û –ü–†–û–ë–õ–ï–ú–ê:**

Frontend –∫–æ–¥ –ü–û–õ–û–ù retry –ª–æ–≥–∏–∫–∏:
- `refreshCsrfTokenWithRetry` - 5 –ø–æ–ø—ã—Ç–æ–∫
- `waitForSessionReady` - 3 –ø–æ–ø—ã—Ç–∫–∏
- Retry –ø–æ—Å–ª–µ 403 –≤ api.ts
- Exponential backoff delays

–≠—Ç–æ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ "–æ–±–æ–π—Ç–∏" race condition –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –µ–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å!

**–†–ï–®–ï–ù–ò–ï:**

1. **Backend:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ —Å–µ—Å—Å–∏—è –≥–æ—Ç–æ–≤–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π response
2. **Backend:** –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å CSRF —Ç–æ–∫–µ–Ω –í –û–¢–í–ï–¢–ï –Ω–∞ login (–Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
3. **Frontend:** –£–±—Ä–∞—Ç—å –í–°–ï retry –º–µ—Ö–∞–Ω–∏–∑–º—ã
4. **Frontend:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tokenconsumer –∏–∑ response, –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

**–ü–†–ò–û–†–ò–¢–ï–¢:** üü° –í–´–°–û–ö–ò–ô

---

### 8. üì® ENDPOINT `/api/csrf-token-init` –î–û–°–¢–£–ü–ï–ù –ë–ï–ó –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò

**–§–∞–π–ª:** `server/index.ts`  
**–°—Ç—Ä–æ–∫–∞:** 113

**–ö–æ–¥:**
```typescript
// Initial CSRF token endpoint (no CSRF protection, used after login/register)
app.get('/api/csrf-token-init', csrfTokenEndpoint);
```

**–ü–†–û–ë–õ–ï–ú–ê:**

–≠—Ç–æ—Ç endpoint:
- –ù–ï —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Å—Å–∏—é
- –ù–ï —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
- –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç `generateCsrfToken(req, res)`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
```typescript
export function csrfTokenEndpoint(req: Request, res: Response): void {
  const csrfToken = generateCsrfToken(req, res);
  res.json({ csrfToken });
}

// –í–Ω—É—Ç—Ä–∏ generateCsrfToken:
getSessionIdentifier: (req: Request) => {
  const sessionId = req.sessionID || req.session?.id;
  return sessionId || 'anonymous'; // ‚ùå
}
```

**–°–¶–ï–ù–ê–†–ò–ô –ü–†–û–ë–õ–ï–ú–´:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è
2. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç `/api/csrf-token-init`
3. –í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç session –ù–ï –ì–û–¢–û–í–ê –≤ –ë–î
4. `req.sessionID` = undefined
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 'anonymous'
6. CSRF —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è 'anonymous'
7. Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω
8. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç, —Å–µ—Å—Å–∏—è –£–ñ–ï –≥–æ—Ç–æ–≤–∞
9. –°–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ sessionId
10. –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è 'anonymous'
11. –í–∞–ª–∏–¥–∞—Ü–∏—è FAILED
12. 403 Forbidden

**–†–ï–®–ï–ù–ò–ï:**

```typescript
app.get('/api/csrf-token-init', authenticateToken, csrfTokenEndpoint);
```

–¢—Ä–µ–±–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é! –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Üí 401.
–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞ –¥–ª—è 'anonymous'.

**–ü–†–ò–û–†–ò–¢–ï–¢:** üü° –í–´–°–û–ö–ò–ô

---

### 9. üåê CORS –ë–õ–û–ö–ò–†–£–ï–¢ –ó–ê–ü–†–û–°–´ –ë–ï–ó Origin HEADER –í PRODUCTION

**–§–∞–π–ª:** `server/middleware/cors.ts`  
**–°—Ç—Ä–æ–∫–∏:** 14-17

**–ö–æ–¥:**
```typescript
if (!origin) {
  logger.warn('CORS rejected request without Origin header in production');
  callback(null, false); // ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
  return;
}
```

**–ü–†–û–ë–õ–ï–ú–ê:**

–í production mode, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç Origin header ‚Üí –ë–õ–û–ö–ò–†–£–ï–¢–°–Ø.

**–ö–æ–≥–¥–∞ –ù–ï–¢ Origin header:**
- Same-origin –∑–∞–ø—Ä–æ—Å—ã (–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω)
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ browser API –∑–∞–ø—Ä–æ—Å—ã
- Server-to-server –∑–∞–ø—Ä–æ—Å—ã
- Preflight OPTIONS (–∏–Ω–æ–≥–¥–∞)

**–í production:**
- Replit –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å reverse proxy
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å Origin header
- –≠—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –ë–õ–û–ö–ò–†–£–Æ–¢–°–Ø
- –í–∫–ª—é—á–∞—è –≤–∞–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ `/api/csrf-token-init`

**–ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–í–ï–î–ï–ù–ò–ï:**

–ï—Å–ª–∏ –ù–ï–¢ Origin ‚Üí —ç—Ç–æ same-origin –∑–∞–ø—Ä–æ—Å ‚Üí –†–ê–ó–†–ï–®–ò–¢–¨.
–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Origin –ï–°–¢–¨ –ù–û –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô.

**–†–ï–®–ï–ù–ò–ï:**

```typescript
if (!origin) {
  // Same-origin request - allow
  callback(null, true);
  return;
}
```

**–ü–†–ò–û–†–ò–¢–ï–¢:** üü° –°–†–ï–î–ù–ò–ô (–≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è, –Ω–æ –≤ prod –º–æ–∂–µ—Ç)

---

## üîµ –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ (P2)

### 10. üóÑÔ∏è SESSION COOKIE –ò CSRF COOKIE –ù–ï–°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–ù–´

**–ü—Ä–æ–±–ª–µ–º–∞:**

Session cookie:
```typescript
cookie: {
  maxAge: 30 * 24 * 60 * 60 * 1000, // 30 –¥–Ω–µ–π
  httpOnly: true,
  ...
}
```

CSRF cookie:
```typescript
cookieOptions: {
  maxAge: 365 * 24 * 60 * 60 * 1000, // 365 –î–ù–ï–ô!
  httpOnly: false,
  ...
}
```

**–ü–†–û–ë–õ–ï–ú–ê:**

1. Session expires —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π
2. CSRF cookie expires —á–µ—Ä–µ–∑ 365 –¥–Ω–µ–π
3. –°–µ—Å—Å–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î
4. –ù–û CSRF cookie –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
5. Frontend –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å CSRF —Ç–æ–∫–µ–Ω
6. –°–µ—Ä–≤–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å (–Ω–µ—Ç —Å–µ—Å—Å–∏–∏)
7. –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ 403 –æ—à–∏–±–∫–∏

**–†–ï–®–ï–ù–ò–ï:**

```typescript
// csrf.ts
cookieOptions: {
  maxAge: 30 * 24 * 60 * 60 * 1000, // –¢–æ –∂–µ —á—Ç–æ session
  ...
}
```

**–ü–†–ò–û–†–ò–¢–ï–¢:** üîµ –°–†–ï–î–ù–ò–ô

---

### 11. üîê SESSION COOKIE –ù–ï –û–ß–ò–©–ê–ï–¢–°–Ø –ü–†–ò CSRF –û–®–ò–ë–ö–ê–•

**–§–∞–π–ª:** `server/middleware/csrf.ts`  
**–°—Ç—Ä–æ–∫–∏:** 47-62

**–ö–æ–¥:**
```typescript
doubleCsrfProtection(req, res, (err) => {
  if (err) {
    if (err === invalidCsrfTokenError) {
      logger.warn('CSRF validation failed', {
        path: req.path,
        method: req.method,
        ip: req.ip,
      });
      return res.status(403).json({ 
        message: '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.' 
      });
    }
    return next(err);
  }
  next();
});
```

**–ü–†–û–ë–õ–ï–ú–ê:**

–ü—Ä–∏ CSRF –æ—à–∏–±–∫–µ:
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 403 Forbidden
- Session cookie –û–°–¢–ê–ï–¢–°–Ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- Frontend –≤–∏–¥–∏—Ç cookie ‚Üí "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω"
- –ù–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è ‚Üí "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω"
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–µ–≤–∏–¥–∏–º—ã–π —Ä–∞–∑–ª–æ–≥–∏–Ω - –ò–ú–ï–ù–ù–û –í–ê–®–ê –ü–†–û–ë–õ–ï–ú–ê!

**–†–ï–®–ï–ù–ò–ï:**

```typescript
if (err === invalidCsrfTokenError) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω–∞—è —Å–µ—Å—Å–∏—è
  if (req.session && req.session.userId) {
    // –°–µ—Å—Å–∏—è –≤–∞–ª–∏–¥–Ω–∞, –Ω–æ —Ç–æ–∫–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω
    const newToken = generateCsrfToken(req, res);
    return res.status(403).json({
      message: 'CSRF token expired',
      csrfToken: newToken // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
    });
  } else {
    // –ù–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ - –ø–æ–ª–Ω—ã–π —Ä–∞–∑–ª–æ–≥–∏–Ω
    res.clearCookie('sessionId');
    res.clearCookie('csrf-token');
    return res.status(401).json({
      message: 'Session expired'
    });
  }
}
```

**–ü–†–ò–û–†–ò–¢–ï–¢:** üîµ –°–†–ï–î–ù–ò–ô

---

### 12. üìù –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï CSRF –ü–†–û–ë–õ–ï–ú

**–§–∞–π–ª:** `server/middleware/csrf.ts`  
**–°—Ç—Ä–æ–∫–∏:** 50-54

**–¢–µ–∫—É—â–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
logger.warn('CSRF validation failed', {
  path: req.path,
  method: req.method,
  ip: req.ip,
  // ‚ùå –ù–ï–¢ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!
});
```

**–ß–¢–û –î–û–õ–ñ–ù–û –õ–û–ì–ò–†–û–í–ê–¢–¨–°–Ø:**

```typescript
logger.warn('CSRF validation failed', {
  path: req.path,
  method: req.method,
  ip: req.ip,
  sessionID: req.sessionID,
  hasSession: !!req.session,
  userId: req.session?.userId,
  sessionAge: req.session ? Date.now() - new Date(req.session.cookie._expires).getTime() : null,
  csrfTokenReceived: req.headers['x-csrf-token']?.substring(0, 10) + '...',
  csrfCookiePresent: !!req.cookies['csrf-token'],
  timestamp: new Date().toISOString()
});
```

–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å root cause.

**–ü–†–ò–û–†–ò–¢–ï–¢:** üîµ –ù–ò–ó–ö–ò–ô (–Ω–æ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è debugging)

---

### 13. üîå WEBSOCKET –ù–ï –ü–†–û–í–ï–†–Ø–ï–¢ CSRF –¢–û–ö–ï–ù

**–§–∞–π–ª:** `server/routes.ts`  
**–°—Ç—Ä–æ–∫–∏:** 127-193

**–ö–æ–¥:**
```typescript
wss.on("connection", async (ws: any, req: any) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Origin
  if (env.NODE_ENV === 'production') {
    const origin = req.headers.origin;
    // ... origin validation
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é
  const sessionData = await validateSessionFromCookie(req.headers.cookie);
  
  // ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ CSRF —Ç–æ–∫–µ–Ω–∞!
});
```

**–ü–†–û–ë–õ–ï–ú–ê:**

- WebSocket –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Origin (–∑–∞—â–∏—Ç–∞ –æ—Ç CSRF)
- WebSocket –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Session (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
- –ù–û HTTP endpoints –ø—Ä–æ–≤–µ—Ä—è—é—Ç CSRF —Ç–æ–∫–µ–Ω
- –í–æ–∑–º–æ–∂–Ω–∞ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
  - WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ
  - HTTP –∑–∞–ø—Ä–æ—Å—ã FAILED –∏–∑-–∑–∞ CSRF
  - Frontend –≤ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

**–†–ï–®–ï–ù–ò–ï:**

WebSocket –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å CSRF —Ç–æ–∫–µ–Ω (Origin –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è WS).
–ù–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Origin validation —Å—Ç—Ä–æ–≥–∞—è.

**–ü–†–ò–û–†–ò–¢–ï–¢:** üîµ –ù–ò–ó–ö–ò–ô

---

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê (ROOT CAUSE)

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö 13 –ø—Ä–æ–±–ª–µ–º, **–∫–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞** —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω–∞:

### **–û–¢–°–£–¢–°–¢–í–ò–ï –ê–¢–û–ú–ê–†–ù–û–°–¢–ò –ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò**

–û–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏ login/register –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ê–¢–û–ú–ê–†–ù–´–ú–ò:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Login ‚Üí Regenerate Session ‚Üí Generate CSRF ‚Üí           ‚îÇ
‚îÇ  Save to DB ‚Üí WAIT FOR COMPLETION ‚Üí Send Response       ‚îÇ
‚îÇ  |___________________ ATOMIC TRANSACTION _______________‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ù–û –°–ï–ô–ß–ê–° –æ–Ω–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã:**

```
Login
  ‚Üì
Regenerate Session (in memory)
  ‚Üì
Save to DB (async, –Ω–µ –∂–¥–µ–º completion)
  ‚Üì
Send Response (–°–†–ê–ó–£)
  ‚Üì
Frontend requests CSRF token (—Å–µ—Å—Å–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ù–ï –ì–û–¢–û–í–ê)
  ‚Üì
CSRF generated with wrong sessionIdentifier
  ‚Üì
RACE CONDITION
  ‚Üì
403 Forbidden
  ‚Üì
–†–ê–ó–õ–û–ì–ò–ù!
```

---

## üìä –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø –ü–†–û–ë–õ–ï–ú

### P0 - –ö–†–ò–¢–ò–ß–ù–û (–ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É):
1. ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è **#1:** CSRF middleware –ø–æ—Å–ª–µ —Ä–æ—É—Ç–æ–≤ ‚Üí CSRF –≤–æ–æ–±—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. üî¥üî¥üî¥ **#2:** sameSite –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí session cookie –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
3. üî¥üî¥ **#3:** 'anonymous' fallback ‚Üí –≤—Å–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω
4. üî¥üî¥üî¥ **#4:** Race condition session save ‚Üí —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
5. üî¥üî¥ **#5:** CSRF –Ω–µ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è ‚Üí —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ sessionId

### P1 - –í–´–°–û–ö–ò–ô (–ü—Ä—è–º–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–æ–≥–∏–Ω):
6. üü° **#6:** –î–≤–∞ CSRF endpoint ‚Üí confusion –∏ race conditions
7. üü° **#7:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ retry ‚Üí —Å–æ–∑–¥–∞—é—Ç –µ—â–µ –±–æ–ª—å—à–µ race conditions
8. üü° **#8:** /csrf-token-init –±–µ–∑ auth ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è 'anonymous'
9. üü° **#9:** CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–µ–∑ Origin ‚Üí –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### P2 - –°–†–ï–î–ù–ò–ô (–£—Ö—É–¥—à–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é):
10. üîµ **#10:** –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ cookie lifetimes
11. üîµ **#11:** Session cookie –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ CSRF –æ—à–∏–±–∫–∞—Ö ‚Üí –Ω–µ–≤–∏–¥–∏–º—ã–π —Ä–∞–∑–ª–æ–≥–∏–Ω
12. üîµ **#12:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí —Å–ª–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
13. üîµ **#13:** WebSocket –±–µ–∑ CSRF ‚Üí –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

---

## üõ†Ô∏è –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –§–∞–∑–∞ 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (P0)

#### 1.1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ middleware
**–§–∞–π–ª:** `server/index.ts`

```typescript
// –ë–´–õ–û:
app.use('/api', generalApiLimiter);
app.get('/api/csrf-token-init', csrfTokenEndpoint);
const webhooksRoutes = await import('./routes/webhooks.routes');
app.use('/api/webhooks', webhooksRoutes.default);
app.use('/api', csrfMiddleware);
app.get('/api/csrf-token', csrfTokenEndpoint);
const server = await registerRoutes(app);

// –î–û–õ–ñ–ù–û –ë–´–¢–¨:
app.use('/api', generalApiLimiter);

// Webhooks –ë–ï–ó CSRF (–æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç signature verification)
const webhooksRoutes = await import('./routes/webhooks.routes');
app.use('/api/webhooks', webhooksRoutes.default);

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ —Ä–æ—É—Ç—ã
const server = await registerRoutes(app);

// Endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –ë–ï–ó CSRF –ø—Ä–æ–≤–µ—Ä–∫–∏
// (–Ω–æ –¢–†–ï–ë–£–ï–¢ –≤–∞–ª–∏–¥–Ω—É—é —Å–µ—Å—Å–∏—é)
app.get('/api/csrf-token-init', authenticateToken, csrfTokenEndpoint);

// CSRF middleware –Ω–∞ –í–°–ï /api/* (–∫—Ä–æ–º–µ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã—à–µ)
app.use('/api', csrfMiddleware);
```

#### 1.2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å sameSite –≤ session cookie
**–§–∞–π–ª:** `server/session.ts`

```typescript
cookie: {
  maxAge: 30 * 24 * 60 * 60 * 1000,
  httpOnly: true,
  secure: env.NODE_ENV === 'production',
  sameSite: env.NODE_ENV === 'production' ? 'strict' : 'lax',
}
```

#### 1.3. –£–±—Ä–∞—Ç—å 'anonymous' fallback
**–§–∞–π–ª:** `server/middleware/csrf.ts`

```typescript
getSessionIdentifier: (req: Request) => {
  const sessionId = req.sessionID || req.session?.id;
  
  if (!sessionId) {
    // –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ 'anonymous'!
    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–ª–∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É
    throw new Error('Session required for CSRF protection');
  }
  
  return sessionId;
}
```

#### 1.4. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å CSRF —Ç–æ–∫–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ login/register
**–§–∞–π–ª:** `server/routes/auth.routes.ts`

```typescript
try {
  await initializeSessionWithUser(req, user.id, roleNames);
  
  // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å CSRF —Ç–æ–∫–µ–Ω –°–ò–ù–•–†–û–ù–ù–û
  const csrfToken = generateCsrfToken(req, res);
  
  res.json({
    user: { ... },
    csrfToken // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ!
  });
}
```

**–§–∞–π–ª:** `client/src/hooks/useAuth.ts`

```typescript
export function useLogin() {
  return useMutation({
    mutationFn: (data: LoginInput) => authApi.login(data),
    onSuccess: async (response) => {
      login(response.user);
      
      // ‚ùå –£–ë–†–ê–¢–¨ refreshCsrfTokenWithRetry!
      // –¢–æ–∫–µ–Ω —É–∂–µ –≤ response.csrfToken
      
      // –û–±–Ω–æ–≤–∏—Ç—å cookie (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      if (response.csrfToken) {
        document.cookie = `csrf-token=${response.csrfToken}; path=/; SameSite=Lax`;
      }
    },
  });
}
```

#### 1.5. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏
**–§–∞–π–ª:** `server/utils/sessionUtils.ts`

```typescript
export async function initializeSessionWithUser(req, userId, roles) {
  await regenerateSession(req);
  req.session.userId = userId;
  req.session.userRoles = roles;
  await saveSession(req);
  
  // –î–æ–±–∞–≤–∏—Ç—å –†–ï–ê–õ–¨–ù–£–Æ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –ë–î
  await verifySessionInDatabase(req.sessionID, 3, 50);
}

async function verifySessionInDatabase(
  sessionId: string, 
  maxAttempts = 3, 
  delayMs = 50
): Promise<void> {
  for (let i = 0; i < maxAttempts; i++) {
    const session = await db.query.sessions.findFirst({
      where: (sessions, { eq }) => eq(sessions.sid, sessionId)
    });
    
    if (session) {
      return; // –°–µ—Å—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î
    }
    
    if (i < maxAttempts - 1) {
      await new Promise(resolve => setTimeout(resolve, delayMs));
    }
  }
  
  throw new Error('Session not found in database after save');
}
```

### –§–∞–∑–∞ 2: –í–ê–ñ–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (P1)

#### 2.1. –£–±—Ä–∞—Ç—å `/api/csrf-token` endpoint
**–§–∞–π–ª:** `server/index.ts`

```typescript
// –£–î–ê–õ–ò–¢–¨ —ç—Ç—É —Å—Ç—Ä–æ–∫—É:
// app.get('/api/csrf-token', csrfTokenEndpoint);

// –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ /api/csrf-token-init
```

#### 2.2. –£–±—Ä–∞—Ç—å retry –ª–æ–≥–∏–∫—É –∏–∑ frontend
**–§–∞–π–ª:** `client/src/hooks/useAuth.ts`

```typescript
// –£–î–ê–õ–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é refreshCsrfTokenWithRetry
// –£–î–ê–õ–ò–¢–¨ –≤—ã–∑–æ–≤—ã refreshCsrfTokenWithRetry –∏–∑ onSuccess
```

**–§–∞–π–ª:** `client/src/lib/api.ts`

```typescript
// –£–î–ê–õ–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é waitForSessionReady
// –£–î–ê–õ–ò–¢–¨ retry –ª–æ–≥–∏–∫—É –ø—Ä–∏ 403

// –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
if (response.status === 403) {
  // –ü—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É, –Ω–µ retry
  throw new ApiError(403, 'CSRF token invalid. Please refresh page.');
}
```

#### 2.3. –¢—Ä–µ–±–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è /csrf-token-init
**–£–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ 1.1**

#### 2.4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS –¥–ª—è production
**–§–∞–π–ª:** `server/middleware/cors.ts`

```typescript
if (!origin) {
  // Same-origin request - allow
  callback(null, true);
  return;
}
```

### –§–∞–∑–∞ 3: –°–†–ï–î–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (P2)

#### 3.1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å cookie lifetimes
**–§–∞–π–ª:** `server/middleware/csrf.ts`

```typescript
cookieOptions: {
  maxAge: 30 * 24 * 60 * 60 * 1000, // –ö–∞–∫ session
  ...
}
```

#### 3.2. –û—á–∏—â–∞—Ç—å session –ø—Ä–∏ CSRF –æ—à–∏–±–∫–∞—Ö
**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ #11**

#### 3.3. –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ #12**

---

## ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

### –¢–µ—Å—Ç 1: –£—Å–ø–µ—à–Ω—ã–π Login Flow
```
1. –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç (–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)
2. Login —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ credentials
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ response —Å–æ–¥–µ—Ä–∂–∏—Ç csrfToken
4. –°–¥–µ–ª–∞—Ç—å POST /api/cart (–¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä)
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ (200 OK)
6. –°–¥–µ–ª–∞—Ç—å –µ—â–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å–æ–≤
7. ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω
```

### –¢–µ—Å—Ç 2: Register Flow
```
1. Register –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ response —Å–æ–¥–µ—Ä–∂–∏—Ç csrfToken
3. –°–¥–µ–ª–∞—Ç—å POST /api/wishlist (–¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ)
4. ‚úÖ –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
```

### –¢–µ—Å—Ç 3: Session Expiry
```
1. Login
2. –£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ –ë–î (–∏–º–∏—Ç–∞—Ü–∏—è expiry)
3. –°–¥–µ–ª–∞—Ç—å POST –∑–∞–ø—Ä–æ—Å
4. ‚úÖ –ü–æ–ª—É—á–∏—Ç—å 401 Unauthorized (–Ω–µ 403!)
5. ‚úÖ Session cookie –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—á–∏—â–µ–Ω
```

### –¢–µ—Å—Ç 4: Rapid Requests
```
1. Login
2. –ë—ã—Å—Ç—Ä–æ —Å–¥–µ–ª–∞—Ç—å 10 POST –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –Ω–µ—Ç race conditions
```

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: 13
- **P0 (–ö—Ä–∏—Ç–∏—á–Ω–æ):** 5 –ø—Ä–æ–±–ª–µ–º
- **P1 (–í—ã—Å–æ–∫–∏–π):** 4 –ø—Ä–æ–±–ª–µ–º—ã  
- **P2 (–°—Ä–µ–¥–Ω–∏–π):** 4 –ø—Ä–æ–±–ª–µ–º—ã

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
**–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** –º–µ–∂–¥—É:
- –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Å–µ—Å—Å–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–µ–π CSRF —Ç–æ–∫–µ–Ω–∞
- –û—Ç–ø—Ä–∞–≤–∫–æ–π response

### –ì–ª–∞–≤–Ω—ã–µ –≤–∏–Ω–æ–≤–Ω–∏–∫–∏ —Ä–∞–∑–ª–æ–≥–∏–Ω–∞:
1. ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #1** - CSRF middleware –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Ä–æ—É—Ç–∞–º
2. üî¥üî¥üî¥ **–ü—Ä–æ–±–ª–µ–º–∞ #4** - Race condition –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
3. üî¥üî¥ **–ü—Ä–æ–±–ª–µ–º–∞ #5** - CSRF –Ω–µ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ session.regenerate()
4. üîµ **–ü—Ä–æ–±–ª–µ–º–∞ #11** - Session cookie –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –†–µ—à–µ–Ω–∏–µ:
–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (P0 ‚Üí P1 ‚Üí P2).
–ü–æ—Å–ª–µ P0 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π 90% —Å–ª—É—á–∞–µ–≤ —Ä–∞–∑–ª–æ–≥–∏–Ω–∞ –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å.

---

**–ö–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞**
